---
import { languages } from '../i18n/ui';
import { getLangFromUrl, getPathWithoutLang } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const pathWithoutLang = getPathWithoutLang(Astro.url.pathname);

const langLabels: Record<string, string> = {
  en: 'EN',
  zh: '中',
  ko: '한',
  ja: '日'
};
---

<div class="language-picker">
  <button class="language-btn" aria-label="Select language">
    <span>{langLabels[lang] || lang}</span>
    <svg width="10" height="10" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M2.5 4L5 6.5L7.5 4"/>
    </svg>
  </button>
  <div class="language-dropdown">
    {Object.entries(languages).map(([code, name]) => (
      <a 
        href={`/${code}${pathWithoutLang}`} 
        data-lang={code}
        class:list={['language-option', { active: code === lang }]}
      >
        {name}
      </a>
    ))}
  </div>
</div>

<script is:inline define:vars={{ lang }}>
  const STORAGE_KEY = 'ralphy_lang';

  try {
    localStorage.setItem(STORAGE_KEY, lang);
  } catch {}

  document.querySelectorAll('.language-option').forEach((el) => {
    el.addEventListener('click', () => {
      const next = el.getAttribute('data-lang');
      if (!next) return;
      try {
        localStorage.setItem(STORAGE_KEY, next);
      } catch {}
    });
  });
</script>

<style>
  .language-picker {
    position: relative;
  }

  .language-btn {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.375rem 0.5rem;
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    color: var(--color-text-muted);
    font-size: 11px;
    font-family: var(--font-mono);
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .language-btn:hover {
    border-color: var(--color-border-hover);
    color: var(--color-text-secondary);
  }

  .language-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 0.375rem;
    background-color: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    padding: 0.375rem;
    min-width: 100px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-4px);
    transition: all 0.15s ease;
    z-index: 50;
  }

  .language-picker:hover .language-dropdown,
  .language-picker:focus-within .language-dropdown {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .language-option {
    display: block;
    padding: 0.375rem 0.5rem;
    border-radius: 4px;
    color: var(--color-text-muted);
    font-size: 11px;
    transition: all 0.15s ease;
  }

  .language-option:hover {
    background-color: var(--color-bg-tertiary);
    color: var(--color-text-secondary);
  }

  .language-option.active {
    color: var(--color-text);
  }
</style>
