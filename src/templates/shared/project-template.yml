# ralphy-spec Project Configuration
# Generated by: ralphy-spec init
# Version: 2.1 (Budget Intelligence + Sprint Semantics)

version: "1.1"

project:
  name: "my-project"
  repoRoot: "."
  language: "ts"
  packageManager: "npm"          # user-defined: npm | pnpm | yarn | bun

defaults:
  backend: "cursor"
  workspaceMode: "patch"       # "worktree" | "patch"
  checkpointMode: "commit"     # "commit" | "patch"
  validators:
    - typecheck
    - test
    - lint

# Artifacts (IDE-friendly human interface)
# NOTE: These are defaults; users can override or disable.
artifacts:
  enabled: true
  rootDir: "ralphy-spec"        # default; can be overridden via CLI: --artifact-dir
  statusIcons: "emoji"          # "emoji" | "ascii" | "none"

# Run-level budgets (hard limits for entire run)
budgets:
  run:
    money_usd: 20              # Max USD per run
    tokens: 2000000            # Max tokens per run
    wall_time_minutes: 90      # Max wall clock time
    max_iterations_total: 80   # Max total iterations across all tasks
  
  limits:
    max_parallel_tasks: 1      # Concurrent tasks (v1: always 1)
    max_parallel_validators: 2 # Concurrent validators
    command_timeout_seconds: 900

# Sprint size defaults (applied when task has sprint.size but no explicit budget)
# Users can override per-task
sprint_defaults:
  XS:
    optimal: { usd: 0.20, tokens: 15000, time_minutes: 3 }
    warning: { usd: 0.35, tokens: 25000, time_minutes: 5 }
    hard: { usd: 0.50, tokens: 40000, time_minutes: 8, max_iterations: 3 }
  S:
    optimal: { usd: 0.50, tokens: 40000, time_minutes: 5 }
    warning: { usd: 0.80, tokens: 65000, time_minutes: 8 }
    hard: { usd: 1.20, tokens: 100000, time_minutes: 12, max_iterations: 5 }
  M:
    optimal: { usd: 1.20, tokens: 80000, time_minutes: 10 }
    warning: { usd: 2.00, tokens: 150000, time_minutes: 15 }
    hard: { usd: 3.00, tokens: 250000, time_minutes: 20, max_iterations: 8 }
  L:
    optimal: { usd: 2.50, tokens: 150000, time_minutes: 20 }
    warning: { usd: 4.00, tokens: 280000, time_minutes: 35 }
    hard: { usd: 6.00, tokens: 450000, time_minutes: 50, max_iterations: 12 }
  XL:
    optimal: { usd: 5.00, tokens: 300000, time_minutes: 40 }
    warning: { usd: 8.00, tokens: 550000, time_minutes: 70 }
    hard: { usd: 12.00, tokens: 900000, time_minutes: 100, max_iterations: 20 }

backends:
  cursor:
    command: "cursor"
    modelTiers:
      default: { hint: "balanced" }
      cheap: { hint: "cheap" }
      strong: { hint: "strong" }
  opencode:
    command: "opencode"
    modelTiers:
      default: {}
      cheap: {}
  claude_code:
    command: "claude"
    modelTiers:
      default: {}

validators:
  - id: "typecheck"
    # Avoid hard-coding package manager. Choose commands that match your repo.
    run: "npm run typecheck"
    timeout_seconds: 600
    parser: "tsc"
  - id: "test"
    run: "npm test"
    timeout_seconds: 900
    parser: "jest"
  - id: "lint"
    run: "npm run lint"
    timeout_seconds: 600
    parser: "eslint"

# Tasks - define your implementation tasks here
tasks: []

# ============================================================
# TASK EXAMPLES (uncomment and modify as needed)
# ============================================================

# Example 1: Simple fix (XS sprint, uses defaults)
# - id: "fix-typo-001"
#   title: "Fix typo in error message"
#   goal: "Correct spelling in validation error"
#   
#   sprint:
#     size: XS                 # Uses XS defaults: $0.20 optimal, 3 max iter
#     intent: "fix"            # No refactoring allowed
#   
#   files_contract:
#     allowed: ["src/utils/validation.ts"]
#     forbidden: []
#     allow_new_files: false
#   
#   acceptance:
#     - id: "acc-1"
#       text: "Error message spelled correctly"
#       type: "behavior"

# Example 2: Feature (M sprint with custom budget)
# - id: "auth-001"
#   title: "JWT middleware"
#   goal: "Add JWT auth middleware for API routes"
#   
#   sprint:
#     size: M
#     intent: "feature"        # Limited refactoring allowed
#   
#   budget:                    # Optional: override sprint defaults
#     optimal:
#       usd: 1.2
#       tokens: 80000
#       time_minutes: 10
#     warning:
#       usd: 2.0
#       tokens: 150000
#       time_minutes: 15
#     hard:
#       usd: 3.0
#       tokens: 250000
#       time_minutes: 20
#       max_iterations: 8
#   
#   files_contract:
#     allowed:
#       - "src/middleware/**"
#       - "src/api/**"
#     forbidden:
#       - "src/db/**"
#     allow_new_files: true
#   
#   context:
#     docs: ["README.md"]
#     files: ["src/api/index.ts"]
#   
#   acceptance:
#     - id: "acc-1"
#       text: "Requests without token return 401"
#       type: "behavior"
#     - id: "acc-2"
#       text: "Valid tokens allow access"
#       type: "behavior"
#     - id: "acc-3"
#       text: "Unit tests added"
#       type: "evidence"
#       evidence:
#         must_include_files: ["src/**/__tests__/**"]
#   
#   validators: ["typecheck", "test", "lint"]
#   done_policy:
#     require_all_validators_pass: true
#     require_acceptance_evidence: true

# Example 3: Large refactor (L sprint)
# - id: "refactor-db-001"
#   title: "Migrate to Prisma"
#   goal: "Replace raw SQL with Prisma ORM"
#   deps: ["auth-001"]         # Depends on auth task
#   
#   sprint:
#     size: L
#     intent: "refactor"       # Full refactoring allowed
#   
#   files_contract:
#     allowed:
#       - "src/db/**"
#       - "prisma/**"
#     forbidden:
#       - "src/api/**"         # Don't touch API layer
#     allow_new_files: true
#   
#   acceptance:
#     - id: "acc-1"
#       text: "All database queries use Prisma"
#       type: "behavior"
#     - id: "acc-2"
#       text: "Existing tests pass"
#       type: "evidence"

# ============================================================
# BUDGET TIERS EXPLAINED
# ============================================================
# 
# OPTIMAL: Expected cost for correct completion
#   - Agent operates normally with full context
#   - All features enabled (self-review, planning)
#
# WARNING: Still acceptable but attention needed
#   - Context shrink: fewer files, only failing tests
#   - Repair-only mode: "fix only, no refactor"
#   - Optional calls disabled
#   - STATUS.md shows pressure signals
#
# HARD: Must stop immediately
#   - Task marked as BLOCKED
#   - Workspace preserved for debugging
#   - Failure summary written
#   - No silent retries
#
# ============================================================
# SPRINT SIZES GUIDE
# ============================================================
#
# XS: Single file fix, typo, simple config change
# S:  Small function, add a test, minor refactor
# M:  Feature slice, new endpoint, component
# L:  Multi-file feature, significant change
# XL: Infrastructure, major refactor, migration
